/// app.js
import DeckGL, {IconLayer} from 'deck.gl';
import ReactMapGL from 'react-map-gl';
import {render} from 'react-dom';
import React, {Component} from 'react';
import 'mapbox-gl/dist/mapbox-gl.css';

// Set your mapbox access token here
const MAPBOX_ACCESS_TOKEN = process.env.REACT_APP_MAPBOX_ACCESS_TOKEN;

// Viewport settings that is shared between mapbox and deck.gl
const DEFAULT_VIEWPORT = {
  longitude: -122.176128,
  latitude: 37.42240, 
  zoom: 16.8,
  maxZoom: 18,
  pitch: 0,
  bearing: 0,
  mapStyle: "mapbox://styles/mapbox/satellite-v9"
};

// data to be used by the IconLayer
const ICON_MAPPING = {
  drone: {x: 0, y: 0, width: 276, height: 276, mask: true},
  vertiport: {x: 276, y: 0, width: 276, height: 276, mask: true}
};

// color mapping of teams to color?
const COLOR_MAPPING = {
	0: [255, 0, 0],
	1: [0, 255, 0]
}


class App extends Component {

  constructor(props) {
    super(props);
    this.state = {
    	droneInfo: [],
    	viewport: {
        ...DEFAULT_VIEWPORT,
        width: 500,
        height: 500
      },
    	index: -1 // delete this once actual data is obtained
    };

		// currently static, but may have to read it in later from DB
		var vertiportLocations = [
			[-122.176247, 37.424190], 
			[-122.174096, 37.423218],
			[-122.173931, 37.421704],
			[-122.175055, 37.420553],
			[-122.177937, 37.421167],
			[-122.177966, 37.423093]
		];

		this.vertiportLayer = this._createIconLayer('vertiport-layer', vertiportLocations.map((loc) => {
			return {position: loc, icon: 'vertiport', size: 100, color: [255, 255, 255]}
		}));
  }

  _createIconLayer(id, data) {
  	return new IconLayer({
	    id: id,
	    data: data,
	    iconAtlas: 'images/image-atlas.png',
	    iconMapping: ICON_MAPPING,
	    fp64: true
	  });
  }

  // // EASIER TO HANDLE FPS
  // componentDidMount() {
  //   this.timerID = setInterval(
  //     () => this._animate(),
  //     1000 / 60
  //   );

  //   // listener for resizing
  //   window.addEventListener('resize', this._resize.bind(this));
  //   this._resize();
  // }

  // componentWillUnmount() {
  //   clearInterval(this.timerID);
  // }


  componentDidMount() {
    window.addEventListener('resize', this._resize.bind(this));
    this._animate(); // default 60 fps
    this._resize();
  }

  componentWillUnmount() {
    if (this._animationFrame) {
      window.cancelAnimationFrame(this._animationFrame);
    }
  }

  _resize() {
    this._onViewportChange({
      width: window.innerWidth,
      height: window.innerHeight
    });
  }

  _onViewportChange(viewport) {
    this.setState({
      viewport: {...this.state.viewport, ...viewport}
    });
  }  

  _animate() {
  	// this will query data eventually, but currently take in static data
  	var droneInfo = [
  		{
	  		locations: [[-122.177966, 37.423093], [-122.17794986, 37.423087444000004], [-122.17793372, 37.423081888], [-122.17791758, 37.423076332], [-122.17790144, 37.423070776], [-122.1778853, 37.42306522], [-122.17786916, 37.423059664], [-122.17785302, 37.423054108], [-122.17783688, 37.423048552000004], [-122.17782074, 37.423042996], [-122.1778046, 37.42303744], [-122.17778846, 37.423031884000004], [-122.17777232, 37.423026328], [-122.17775618, 37.423020772], [-122.17774004, 37.423015216], [-122.1777239, 37.423009660000005], [-122.17770776, 37.423004104], [-122.17769162, 37.422998548], [-122.17767547999999, 37.422992992], [-122.17765933999999, 37.422987436], [-122.17764319999999, 37.422981879999995], [-122.17762705999999, 37.422976324], [-122.17761091999999, 37.422970768], [-122.17759477999999, 37.422965212], [-122.17757864, 37.422959655999996], [-122.1775625, 37.4229541], [-122.17754636, 37.422948544], [-122.17753022, 37.422942987999996], [-122.17751408, 37.422937432], [-122.17749794, 37.422931876], [-122.1774818, 37.42292632], [-122.17746566, 37.422920764], [-122.17744952, 37.422915208], [-122.17743338, 37.422909652], [-122.17741724, 37.422904095999996], [-122.1774011, 37.42289854], [-122.17738496, 37.422892984], [-122.17736882, 37.422887428], [-122.17735268, 37.422881872], [-122.17733654, 37.422876316], [-122.1773204, 37.42287076], [-122.17730426, 37.422865204], [-122.17728812, 37.422859648], [-122.17727198, 37.422854092], [-122.17725584, 37.422848536000004], [-122.1772397, 37.42284298], [-122.17722356, 37.422837424], [-122.17720742, 37.422831868], [-122.17719128, 37.422826312], [-122.17717514, 37.422820756], [-122.177159, 37.4228152], [-122.17714286, 37.422809644000004], [-122.17712672, 37.422804088], [-122.17711058, 37.422798532], [-122.17709443999999, 37.422792976], [-122.17707829999999, 37.42278742], [-122.17706215999999, 37.422781864], [-122.17704601999999, 37.422776307999996], [-122.17702987999999, 37.422770752], [-122.17701373999999, 37.422765196], [-122.17699759999999, 37.422759639999995], [-122.17698146, 37.422754084], [-122.17696532, 37.422748528], [-122.17694918, 37.422742972], [-122.17693304, 37.422737416], [-122.1769169, 37.42273186], [-122.17690076, 37.422726304], [-122.17688462, 37.422720747999996], [-122.17686848, 37.422715192], [-122.17685234, 37.422709636], [-122.1768362, 37.42270408], [-122.17682006, 37.422698524], [-122.17680392, 37.422692968], [-122.17678778, 37.422687412], [-122.17677164, 37.422681856], [-122.1767555, 37.4226763], [-122.17673936, 37.422670744], [-122.17672322, 37.422665188], [-122.17670708, 37.422659632], [-122.17669094, 37.422654076], [-122.1766748, 37.42264852], [-122.17665866, 37.422642964], [-122.17664252, 37.422637408], [-122.17662638, 37.422631852], [-122.17661024, 37.422626296000004], [-122.1765941, 37.42262074], [-122.17657796, 37.422615184], [-122.17656182, 37.422609628000004], [-122.17654568, 37.422604072], [-122.17652954, 37.422598516], [-122.17651339999999, 37.422592959999996], [-122.17649725999999, 37.422587404], [-122.17648111999999, 37.422581848], [-122.17646497999999, 37.422576291999995], [-122.17644883999999, 37.422570736], [-122.17643269999999, 37.42256518], [-122.17641655999999, 37.422559623999994], [-122.17640042, 37.422554068], [-122.17638428, 37.422548512], [-122.17636814, 37.422542956], [-122.176352, 37.422537399999996], [-122.17633586, 37.422531844], [-122.17631972, 37.422526288], [-122.17630358, 37.422520731999995], [-122.17628744, 37.422515176], [-122.1762713, 37.42250962], [-122.17625516, 37.422504064], [-122.17623902, 37.422498508], [-122.17622288, 37.422492952], [-122.17620674, 37.422487396], [-122.1761906, 37.422481839999996], [-122.17617446, 37.422476284], [-122.17615832, 37.422470728], [-122.17614218, 37.422465172], [-122.17612604, 37.422459616], [-122.1761099, 37.42245406], [-122.17609376, 37.422448504], [-122.17607762, 37.422442948], [-122.17606148, 37.422437392], [-122.17604534, 37.422431836], [-122.1760292, 37.42242628], [-122.17601306, 37.422420724], [-122.17599692, 37.422415168], [-122.17598078, 37.422409612], [-122.17596464, 37.422404056], [-122.1759485, 37.4223985], [-122.17593235999999, 37.422392943999995], [-122.17591621999999, 37.422387388], [-122.17590007999999, 37.422381832], [-122.17588393999999, 37.422376275999994], [-122.17586779999999, 37.422370719999996], [-122.17585165999999, 37.422365164], [-122.17583551999999, 37.422359608], [-122.17581938, 37.422354051999996], [-122.17580324, 37.422348496], [-122.1757871, 37.42234294], [-122.17577096, 37.422337383999995], [-122.17575482, 37.422331828], [-122.17573868, 37.422326272], [-122.17572254, 37.422320716], [-122.1757064, 37.42231516], [-122.17569026, 37.422309604], [-122.17567412, 37.422304048], [-122.17565798, 37.422298491999996], [-122.17564184, 37.422292936], [-122.1756257, 37.42228738], [-122.17560956, 37.422281824], [-122.17559342, 37.422276268], [-122.17557728, 37.422270712], [-122.17556114, 37.422265156], [-122.175545, 37.4222596], [-122.17552886, 37.422254044], [-122.17551272, 37.422248488], [-122.17549658, 37.422242932], [-122.17548044, 37.422237376], [-122.1754643, 37.42223182], [-122.17544816, 37.422226264], [-122.17543202, 37.422220708], [-122.17541588, 37.422215152], [-122.17539974, 37.422209596], [-122.1753836, 37.422204040000004], [-122.17536745999999, 37.422198484], [-122.17535131999999, 37.422192927999994], [-122.17533517999999, 37.422187371999996], [-122.17531903999999, 37.422181816], [-122.17530289999999, 37.42217625999999], [-122.17528675999999, 37.422170703999996], [-122.17527061999999, 37.422165148], [-122.17525447999999, 37.422159592], [-122.17523833999999, 37.422154035999995], [-122.1752222, 37.42214848], [-122.17520606, 37.422142924], [-122.17518992, 37.422137367999994], [-122.17517378, 37.422131811999996], [-122.17515764, 37.422126256], [-122.1751415, 37.4221207], [-122.17512536, 37.422115143999996], [-122.17510922, 37.422109588], [-122.17509308, 37.422104032], [-122.17507694, 37.422098475999995], [-122.1750608, 37.42209292], [-122.17504466, 37.422087364], [-122.17502852, 37.422081808], [-122.17501238, 37.422076252], [-122.17499624, 37.422070696], [-122.1749801, 37.42206514], [-122.17496396, 37.422059583999996], [-122.17494782, 37.422054028], [-122.17493168, 37.422048472], [-122.17491554, 37.422042916], [-122.1748994, 37.42203736], [-122.17488326, 37.422031804], [-122.17486712, 37.422026248], [-122.17485098, 37.422020692], [-122.17483484, 37.422015136], [-122.1748187, 37.42200958], [-122.17480256, 37.422004024], [-122.17478641999999, 37.421998468], [-122.17477027999999, 37.42199291199999], [-122.17475413999999, 37.421987355999995], [-122.17473799999999, 37.4219818], [-122.17472185999999, 37.42197624399999], [-122.17470571999999, 37.421970687999995], [-122.17468957999999, 37.421965132], [-122.17467343999999, 37.421959576], [-122.17465729999999, 37.421954019999994], [-122.17464116, 37.421948463999996], [-122.17462502, 37.421942908], [-122.17460888, 37.42193735199999], [-122.17459274, 37.421931795999996], [-122.1745766, 37.42192624], [-122.17456046, 37.421920684], [-122.17454432, 37.421915127999995], [-122.17452818, 37.421909572], [-122.17451204, 37.421904016], [-122.1744959, 37.421898459999994], [-122.17447976, 37.421892903999996], [-122.17446362, 37.421887348], [-122.17444748, 37.421881792], [-122.17443134, 37.421876235999996], [-122.1744152, 37.42187068], [-122.17439906, 37.421865124], [-122.17438292, 37.421859567999995], [-122.17436678, 37.421854012], [-122.17435064, 37.421848456], [-122.1743345, 37.4218429], [-122.17431836, 37.421837344], [-122.17430222, 37.421831788], [-122.17428608, 37.421826232], [-122.17426994, 37.421820676], [-122.1742538, 37.42181512], [-122.17423766, 37.421809564], [-122.17422152, 37.421804008], [-122.17420537999999, 37.421798452], [-122.17418923999999, 37.42179289599999], [-122.17417309999999, 37.421787339999995], [-122.17415695999999, 37.421781784], [-122.17414081999999, 37.421776228], [-122.17412467999999, 37.421770671999994], [-122.17410853999999, 37.421765115999996], [-122.17409239999999, 37.42175956], [-122.17407625999999, 37.42175400399999], [-122.17406012, 37.421748447999995], [-122.17404398, 37.421742892], [-122.17402784, 37.421737336], [-122.1740117, 37.421731779999995], [-122.17399556, 37.421726224], [-122.17397942, 37.421720668], [-122.17396328, 37.421715111999994], [-122.17394714, 37.421709555999996]],
	  		team: 0
	  	}, {
	  		locations: [[-122.176247, 37.42419000000001], [-122.176242232, 37.42417545200004], [-122.17623746400001, 37.424160904000075], [-122.176232696, 37.424146355999994], [-122.176227928, 37.42413180800003], [-122.17622316, 37.42411726000006], [-122.17621839200001, 37.424102712000035], [-122.176213624, 37.42408816400001], [-122.176208856, 37.424073616000044], [-122.176204088, 37.42405906800002], [-122.17619932000001, 37.42404452000005], [-122.176194552, 37.42402997200003], [-122.176189784, 37.424015424000004], [-122.176185016, 37.424000876000036], [-122.17618024800001, 37.42398632800007], [-122.17617548, 37.42397177999999], [-122.176170712, 37.42395723200002], [-122.176165944, 37.42394268400005], [-122.17616117600001, 37.42392813600003], [-122.176156408, 37.423913588000005], [-122.17615164, 37.42389904000004], [-122.176146872, 37.42388449200001], [-122.17614210400001, 37.423869944000046], [-122.176137336, 37.42385539600002], [-122.176132568, 37.423840848], [-122.1761278, 37.42382630000003], [-122.176123032, 37.42381175200006], [-122.17611826400001, 37.42379720400004], [-122.176113496, 37.423782656000014], [-122.176108728, 37.42376810800005], [-122.17610396, 37.42375356000002], [-122.17609919200001, 37.423739012000055], [-122.176094424, 37.42372446400003], [-122.176089656, 37.42370991600001], [-122.176084888, 37.42369536800004], [-122.17608012000001, 37.42368082000007], [-122.176075352, 37.42366627199999], [-122.176070584, 37.423651724000024], [-122.176065816, 37.42363717600006], [-122.17606104800001, 37.42362262800003], [-122.17605628, 37.42360808000001], [-122.176051512, 37.42359353200004], [-122.176046744, 37.42357898400002], [-122.17604197600001, 37.42356443600005], [-122.176037208, 37.423549888000025], [-122.17603244, 37.42353534], [-122.176027672, 37.42352079200003], [-122.176022904, 37.423506244000066], [-122.176018136, 37.423491695999985], [-122.176013368, 37.42347714800002], [-122.1760086, 37.42346260000005], [-122.176003832, 37.423448052000026], [-122.17599906400001, 37.42343350400006], [-122.175994296, 37.423418956000035], [-122.175989528, 37.42340440800001], [-122.17598476, 37.42338986000004], [-122.17597999200001, 37.423375312000076], [-122.175975224, 37.423360763999995], [-122.175970456, 37.42334621600003], [-122.175965688, 37.42333166800006], [-122.17596092000001, 37.423317120000036], [-122.175956152, 37.42330257200001], [-122.175951384, 37.423288024000044], [-122.175946616, 37.42327347600002], [-122.17594184800001, 37.42325892800005], [-122.17593708, 37.42324438000003], [-122.175932312, 37.423229832000004], [-122.175927544, 37.42321528400004], [-122.17592277600001, 37.42320073600007], [-122.175918008, 37.42318618799999], [-122.17591324, 37.42317164000002], [-122.175908472, 37.423157092000054], [-122.175903704, 37.42314254400003], [-122.175898936, 37.423127996000005], [-122.175894168, 37.42311344800004], [-122.1758894, 37.423098900000014], [-122.175884632, 37.423084352000046], [-122.17587986400001, 37.42306980400008], [-122.175875096, 37.423055256], [-122.175870328, 37.42304070800003], [-122.17586556, 37.42302616000006], [-122.17586079200001, 37.42301161200004], [-122.175856024, 37.422997064000015], [-122.175851256, 37.42298251600005], [-122.175846488, 37.42296796800002], [-122.17584172000001, 37.422953420000056], [-122.175836952, 37.42293887200003], [-122.175832184, 37.42292432400001], [-122.175827416, 37.42290977600004], [-122.17582264800001, 37.42289522800007], [-122.17581788, 37.42288067999999], [-122.175813112, 37.422866132000024], [-122.175808344, 37.42285158400006], [-122.175803576, 37.42283703600003], [-122.175798808, 37.42282248800001], [-122.17579404, 37.42280794000004], [-122.175789272, 37.42279339200002], [-122.175784504, 37.42277884400005], [-122.175779736, 37.422764296000025], [-122.175774968, 37.422749748], [-122.1757702, 37.422735200000034], [-122.175765432, 37.422720652000066], [-122.17576066400001, 37.42270610400004], [-122.175755896, 37.42269155600002], [-122.175751128, 37.42267700800005], [-122.17574636, 37.422662460000026], [-122.17574159200001, 37.42264791200006], [-122.175736824, 37.422633364000035], [-122.175732056, 37.42261881600001], [-122.175727288, 37.42260426800004], [-122.17572252000001, 37.42258972000002], [-122.175717752, 37.422575171999995], [-122.175712984, 37.42256062400003], [-122.175708216, 37.42254607600006], [-122.17570344800001, 37.422531528000036], [-122.17569868, 37.42251698000001], [-122.175693912, 37.422502432000044], [-122.175689144, 37.42248788400002], [-122.175684376, 37.42247333600005], [-122.175679608, 37.42245878800003], [-122.17567484, 37.422444240000004], [-122.175670072, 37.42242969200004], [-122.175665304, 37.42241514400007], [-122.175660536, 37.42240059599999], [-122.175655768, 37.42238604800002], [-122.175651, 37.422371500000054], [-122.175646232, 37.42235695200003], [-122.17564146400001, 37.42234240400006], [-122.175636696, 37.42232785600004], [-122.175631928, 37.422313308000014], [-122.17562716, 37.42229876000005], [-122.17562239200001, 37.42228421200002], [-122.175617624, 37.422269664], [-122.175612856, 37.42225511600003], [-122.175608088, 37.42224056800006], [-122.17560332000001, 37.42222602000004], [-122.175598552, 37.422211472000015], [-122.175593784, 37.42219692400005], [-122.175589016, 37.42218237600002], [-122.175584248, 37.422167828000056], [-122.17557948, 37.42215328000003], [-122.175574712, 37.42213873200001], [-122.175569944, 37.42212418400004], [-122.175565176, 37.422109636000016], [-122.175560408, 37.42209508799999], [-122.17555564, 37.422080540000024], [-122.175550872, 37.42206599200006], [-122.175546104, 37.42205144400003], [-122.175541336, 37.42203689600001], [-122.175536568, 37.42202234800004], [-122.1755318, 37.42200780000002], [-122.175527032, 37.42199325200005], [-122.17552226400001, 37.421978704000026], [-122.175517496, 37.421964156], [-122.175512728, 37.421949608000034], [-122.17550796, 37.42193506000001], [-122.17550319200001, 37.42192051200004], [-122.175498424, 37.42190596400002], [-122.175493656, 37.42189141600005], [-122.175488888, 37.42187686800003], [-122.17548412000001, 37.42186232000006], [-122.175479352, 37.421847772000035], [-122.175474584, 37.42183322400001], [-122.175469816, 37.42181867600004], [-122.175465048, 37.42180412800002], [-122.17546028, 37.421789579999995], [-122.175455512, 37.42177503200003], [-122.175450744, 37.421760484], [-122.175445976, 37.421745936000036], [-122.175441208, 37.42173138800001], [-122.17543644, 37.421716840000045], [-122.175431672, 37.42170229200002], [-122.175426904, 37.42168774400005], [-122.175422136, 37.42167319600003], [-122.175417368, 37.421658648000005], [-122.1754126, 37.42164410000004], [-122.175407832, 37.42162955200001], [-122.17540306400001, 37.421615004000046], [-122.175398296, 37.42160045600002], [-122.175393528, 37.421585908000054], [-122.17538876, 37.42157136000003], [-122.17538399200001, 37.42155681200006], [-122.175379224, 37.42154226400004], [-122.175374456, 37.421527716000014], [-122.175369688, 37.42151316800005], [-122.17536492, 37.42149862000002], [-122.175360152, 37.421484072], [-122.175355384, 37.42146952400003], [-122.175350616, 37.42145497600001], [-122.175345848, 37.42144042800004], [-122.17534108, 37.421425880000015], [-122.175336312, 37.42141133200005], [-122.175331544, 37.421396784000024], [-122.175326776, 37.421382236000056], [-122.175322008, 37.42136768800003], [-122.17531724, 37.42135314000001], [-122.175312472, 37.42133859200004], [-122.175307704, 37.421324044000016], [-122.175302936, 37.42130949599999], [-122.175298168, 37.421294948000025], [-122.1752934, 37.4212804], [-122.175288632, 37.42126585200003], [-122.17528386400001, 37.421251304000066], [-122.175279096, 37.42123675600004], [-122.175274328, 37.42122220800002], [-122.17526956, 37.42120766000005], [-122.17526479200001, 37.421193112000026], [-122.175260024, 37.421178564], [-122.175255256, 37.421164016000034], [-122.175250488, 37.42114946800001], [-122.17524572, 37.42113492000004], [-122.175240952, 37.42112037200002], [-122.175236184, 37.421105823999994], [-122.175231416, 37.42109127600003], [-122.175226648, 37.42107672800006], [-122.17522188, 37.421062180000035], [-122.175217112, 37.42104763200001], [-122.175212344, 37.421033084000044], [-122.175207576, 37.42101853600002], [-122.175202808, 37.421003987999995], [-122.17519804, 37.42098944000003], [-122.175193272, 37.420974892000004], [-122.175188504, 37.42096034400004], [-122.175183736, 37.42094579600001], [-122.175178968, 37.420931248000045], [-122.1751742, 37.42091670000002], [-122.175169432, 37.42090215200005], [-122.17516466400001, 37.42088760400003], [-122.175159896, 37.420873056000005], [-122.175155128, 37.42085850800004], [-122.17515036, 37.42084396000001], [-122.175145592, 37.420829412000046], [-122.175140824, 37.42081486400002], [-122.175136056, 37.420800316], [-122.175131288, 37.42078576800003], [-122.17512652, 37.42077122000006], [-122.175121752, 37.42075667200004], [-122.175116984, 37.420742124000014], [-122.175112216, 37.42072757600005], [-122.175107448, 37.42071302800002], [-122.17510268, 37.42069848], [-122.175097912, 37.42068393200003], [-122.175093144, 37.42066938400001], [-122.175088376, 37.42065483600004], [-122.175083608, 37.420640288000016], [-122.17507884, 37.42062573999999], [-122.175074072, 37.420611192000024], [-122.175069304, 37.42059664400006], [-122.175064536, 37.42058209600003], [-122.175059768, 37.42056754800001]], 
	  		team: 1
	  	}
	  ];

  	// delete once actual data is obtained
  	var newIndex = (this.state.index + 1) % droneInfo[0].locations.length;

  	this.setState({
    	droneInfo: droneInfo.map((currDrone) => {
    		// return currDrone;
    		return {...currDrone, location: currDrone.locations[newIndex]}
    	}),
			viewport: {...this.state.viewport, bearing: (this.state.viewport.bearing + 0.1) % 360},
    	index: newIndex // delete this once actual data is obtained  		
  	})

  	// comment out when using defined FPS
    this._animationFrame = window.requestAnimationFrame(this._animate.bind(this));
  }


  render() {
  	var droneData = this.state.droneInfo.map((currDrone) => {
  		return {position: currDrone.location, icon: 'drone', size: 125, color: COLOR_MAPPING[currDrone.team]}
  	});

		var droneLayer = new IconLayer({
	    id: 'drone-layer',
	    data: droneData,
	    iconAtlas: 'images/image-atlas.png',
	    iconMapping: ICON_MAPPING
	  });

		return (
      <ReactMapGL {...this.state.viewport} mapboxApiAccessToken={MAPBOX_ACCESS_TOKEN} onViewportChange={this._onViewportChange.bind(this)}>
        <DeckGL {...this.state.viewport} layers={[
        	this.vertiportLayer,
          droneLayer,
        ]} />
      </ReactMapGL>
    );
  }
}

// TO DO
// control panel with following functionality
// 1. choose between rotating / non-rotating
// 		a. rotating: choose rate
// 		b. non-rotating: choose bearing
// 2. ability to alter pitch


render(<App />, document.body.appendChild(document.createElement('div')));
